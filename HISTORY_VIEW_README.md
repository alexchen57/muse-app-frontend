# 历史数据视图功能说明

## 概述

历史数据视图（HistoryView）是 MUSE 应用的核心功能之一，用于查看和分析用户的历史生理数据和状态信息。

## 功能特性

### 1. 📅 时间范围选择
- **今天**: 查看当日的所有数据
- **最近7天**: 查看过去一周的数据趋势
- **最近30天**: 查看过去一个月的数据统计
- **自定义**: 选择任意时间段进行分析

### 2. 📈 数据统计摘要
显示选定时间范围内的关键指标：
- **心率统计**
  - 平均心率
  - 最高心率
  - 最低心率
  - 心率范围
  
- **心智负荷（MWL）统计**
  - 平均 MWL
  - 最高 MWL
  - 最低 MWL
  - MWL 范围

- **数据完整性**
  - 数据点总数
  - 记录总时长

### 3. 🎭 状态分布分析
以可视化方式展示不同状态的时间分布：
- **压力状态（Stressed）**: 红色
- **平静状态（Calm）**: 绿色
- **高效状态（Productive）**: 蓝色
- **分心状态（Distracted）**: 黄色

每个状态显示：
- 占比百分比
- 持续时长
- 可视化进度条

### 4. 📊 历史趋势图表
- **心率历史趋势图**: 显示心率随时间的变化
- **MWL 历史趋势图**: 显示心智负荷随时间的变化
- 使用与实时图表相同的 RealtimeChart 组件，确保视觉一致性

### 5. 🕒 状态历史时间线
详细的状态变化记录，包括：
- 状态开始时间
- 状态类型
- 持续时长
- 置信度
- 彩色标签和边框，便于快速识别

## 技术实现

### 数据来源
历史数据从 IndexedDB 数据库（Dexie）中读取：
- `heartRate` 表: 存储心率数据
- `mwl` 表: 存储 MWL 数据
- `stateHistory` 表: 存储状态历史记录

### 数据查询
使用 Dexie 的时间范围查询：
```typescript
await db.heartRate
  .where('timestamp')
  .between(startTimestamp, endTimestamp)
  .toArray();
```

### 性能优化
- 使用 `useMemo` 缓存计算结果
- 只在时间范围变化时重新加载数据
- 状态历史时间线支持滚动，避免渲染过多元素

### 响应式设计
- 使用 CSS Grid 布局，自动适应不同屏幕尺寸
- 图表和统计卡片自动调整大小
- 移动设备友好

## 使用方法

### 访问历史数据视图
1. 在应用侧边栏点击 "📊 History" 菜单项
2. 系统会自动加载今天的历史数据
3. 根据需要选择不同的时间范围

### 自定义时间范围
1. 点击"自定义"按钮
2. 使用日期时间选择器设置开始日期
3. 设置结束日期
4. 系统自动重新加载该时间段的数据

### 数据解读
- **心率偏高**: 可能表示压力、焦虑或身体活动
- **MWL 偏高**: 表示认知负荷较重，可能需要休息
- **状态频繁切换**: 可能表示工作环境不稳定或需要调整
- **平静状态占比高**: 表示良好的工作生活平衡

## 数据隐私

所有历史数据都存储在本地浏览器的 IndexedDB 中，不会上传到任何服务器。用户可以：
- 完全控制自己的数据
- 清除浏览器数据时会同时删除历史记录
- 无需担心隐私泄露

## 未来功能规划

- [ ] 数据导出功能（CSV/JSON）
- [ ] 更详细的统计分析（周报/月报）
- [ ] 趋势预测和建议
- [ ] 自定义数据可视化
- [ ] 状态关联分析（与音乐播放关联）
- [ ] 数据对比功能（对比不同时间段）

## 故障排查

### 没有数据显示
- 确保已经运行过心率和 MWL 模拟器
- 检查选择的时间范围是否正确
- 在浏览器开发者工具中检查 IndexedDB

### 图表无法显示
- 确保有足够的数据点（至少2个）
- 检查浏览器控制台是否有错误
- 刷新页面重试

### 性能问题
- 缩小时间范围以减少数据量
- 清除过旧的历史数据
- 使用现代浏览器以获得最佳性能

## 技术栈

- **React**: UI 框架
- **TypeScript**: 类型安全
- **Dexie.js**: IndexedDB 封装
- **date-fns**: 日期处理
- **Recharts**: 数据可视化（通过 RealtimeChart 组件）

## 相关文件

- `/src/components/HistoryView.tsx`: 主组件
- `/src/utils/db.ts`: 数据库配置
- `/src/types/device.ts`: 设备数据类型
- `/src/types/state.ts`: 状态类型定义
- `/src/components/RealtimeChart.tsx`: 图表组件
